// Prisma schema for Untis Pro backend
// Auto-migrated to keep DB in sync

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id        String   @id @default(uuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    username String
    // hashed or encrypted password at rest; for demo we store as text. Replace with vault/KMS in prod.
    password String

    displayName String?

    // Sharing preferences
    sharingEnabled Boolean @default(false) // By default, new accounts don't share
    
    // Relationships
    timetables   Timetable[]
    sessions     SessionToken[]
    lessonColors LessonColorSetting[]
    
    // Sharing relationships
    sharingWith     TimetableShare[] @relation("UserSharingWith")
    sharedWithBy    TimetableShare[] @relation("UserSharedWithBy")

    @@unique([username])
}

model Timetable {
    id        String   @id @default(uuid())
    createdAt DateTime @default(now())
    ownerId   String
    owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

    // Cached JSON from WebUntis; keep flexible
    rangeStart DateTime?
    rangeEnd   DateTime?
    payload    Json
}

model SessionToken {
    id        String   @id @default(uuid())
    createdAt DateTime @default(now())
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    token     String   @unique
    expiresAt DateTime
}

model LessonColorSetting {
    id         String   @id @default(uuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt
    userId     String
    user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    lessonName String // Subject name like "Math", "English", etc.
    color      String // Hex color code like "#3b82f6"
    offset     Float    @default(0.5) // Gradient offset 0..1

    @@unique([userId, lessonName])
}

model DefaultLessonColor {
    id         String   @id @default(uuid())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt
    lessonName String   @unique // Subject name
    color      String // Default hex color code
    offset     Float    @default(0.5) // Gradient offset 0..1
}

model TimetableShare {
    id        String   @id @default(uuid())
    createdAt DateTime @default(now())
    
    // User who is sharing their timetable
    ownerId   String
    owner     User     @relation("UserSharingWith", fields: [ownerId], references: [id], onDelete: Cascade)
    
    // User who can view the timetable
    sharedWithId String
    sharedWith   User     @relation("UserSharedWithBy", fields: [sharedWithId], references: [id], onDelete: Cascade)
    
    @@unique([ownerId, sharedWithId])
}

model AppSettings {
    id        String   @id @default(uuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    // Global setting for admins to disable all sharing
    globalSharingEnabled Boolean @default(true)
}
